@{
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
    ViewBag.Title = "Administración General";
}
<style>
    .modal-header {
        background-color: #2D594D;
        color: #fff;
        border-top-left-radius: .5rem;
        border-top-right-radius: .5rem;
    }

    .modal-content {
        border-radius: .5rem;
        overflow: hidden;
    }

    .modal-footer .btn-cancelar {
        background-color: #F2F2F2;
        color: #2D594D;
        border: 1px solid #2D594D;
        transition: all 0.3s;
    }

        .modal-footer .btn-cancelar:hover {
            background-color: #EAF2D8;
        }

    .modal-footer .btn-guardar {
        background-color: #8CA653;
        color: #fff;
        transition: all 0.3s;
    }

        .modal-footer .btn-guardar:hover {
            background-color: #768C46;
        }
</style>
<section class="vacantes-wrapper">
    <h2 class="vacantes-titulo titulo-principal">Administración General</h2>


    <div class="container mt-4">
        <div class="row gy-3 mb-4">
            <div class="col-md-4">
                <button class="btn btn-outline-usuarios w-100 py-3 shadow rounded-4"
                        onclick="mostrarSeccion('usuarios')">
                    <i class="fas fa-users me-2"></i> Gestión de Usuarios
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-especialidades w-100 py-3 shadow rounded-4"
                        onclick="mostrarSeccion('especialidades')">
                    <i class="fas fa-tools me-2"></i> Gestión de Especialidades
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-secciones w-100 py-3 shadow rounded-4"
                        onclick="mostrarSeccion('secciones')">
                    <i class="fas fa-layer-group me-2"></i> Gestión de Secciones
                </button>
            </div>
        </div>
    </div>


    <!-- Gestión de Usuarios -->
    <div id="usuarios" class="seccion-adm" style="display: none;">
        <h3 class="text-center">Gestión de Usuarios</h3>

        <!-- Filtro por Rol -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="filtroRol" class="form-label">Filtrar por rol:</label>
                <select id="filtroRol" class="form-control">
                    <option value="">Todos</option>
                    <option value="Estudiante">Estudiante</option>
                    <option value="Profesor">Profesor</option>
                    <option value="Egresado">Egresado</option>
                    <option value="Coordinador">Coordinador</option>
                </select>
            </div>
        </div>

        <!-- Tabla de Usuarios -->
        <div class="table-container">
            <table id="tablaUsuarios" class="display responsive nowrap w-100">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Cédula</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-rol="Estudiante">
                        <td>Laura Rodríguez</td>
                        <td>12345678</td>
                        <td>laura@email.com</td>
                        <td>Estudiante</td>
                        <td class="estado">Activo</td>
                        <td>
                            <a href="#"
                               class="btn bg-transparent btn-editar-rol-usuario me-1"
                               data-id="1"
                               data-nombre="Laura Rodríguez"
                               data-cedula="12345678"
                               data-email="laura@email.com"
                               title="Editar Rol">
                                <i class="fas fa-user-cog icono-accion"></i>
                            </a>


                            <a href="#" class="btn bg-transparent" title="Inactivar" onclick="confirmarCambioEstado(this)">
                                <i class="fas fa-user-slash icono-accion"></i>
                            </a>
                        </td>
                    </tr>
                    <!-- Más usuarios dinámicos -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gestión de Especialidades -->
    <div id="especialidades" class="seccion-adm" style="display: none;">
        <h3 class="text-center">Especialidades Registradas</h3>

        <button type="button"
                class="btn-cta btn-nuevo mb-3"
                data-bs-toggle="modal"
                data-bs-target="#modalCrearEspecialidad">
            + Nueva Especialidad
        </button>


        <div class="table-container">
            <table id="tablaEspecialidades" class="display responsive nowrap w-100">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-id="1">
                        <td>Informática</td>
                        <td>Desarrollo de software y redes</td>
                        <td>
                            <a href="#"
                               class="btn bg-transparent btn-editar-especialidad"
                               data-id="1"
                               data-nombre="Informática"
                               data-descripcion="Desarrollo de software y redes"
                               title="Editar">
                                <i class="fas fa-edit icono-accion"></i>
                            </a>

                            <a href="#"
                               class="btn bg-transparent btn-eliminar-especialidad"
                               data-id="1"
                               data-nombre="Informática"
                               title="Eliminar">
                                <i class="fas fa-trash-alt icono-accion"></i>
                            </a>
                        </td>
                    </tr>
                    <!-- Más especialidades -->
                </tbody>
            </table>
            <!-- Modal Confirmar Eliminación Especialidad -->
            <div class="modal fade" id="modalEliminarEspecialidad" tabindex="-1" aria-labelledby="modalEliminarEspecialidadLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirmar Eliminación</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            ¿Está seguro que desea eliminar esta especialidad?
                        </div>
                        <div class="modal-footer">
                            <form id="formEliminarEspecialidad">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-danger">Eliminar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestión de Secciones -->
    <div id="secciones" class="seccion-adm" style="display: none;">
        <h3 class="text-center">Secciones Registradas</h3>

        <button type="button"
                class="btn-cta btn-nuevo mb-3"
                data-bs-toggle="modal"
                data-bs-target="#modalCrearSeccion">
            + Nueva Sección
        </button>


        <div class="table-container">
            <table id="tablaSecciones" class="display responsive nowrap w-100">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-id="1">
                        <td>SEC-01</td>
                        <td>
                            <a href="#"
                               class="btn bg-transparent btn-editar-seccion"
                               data-id="1"
                               data-nombre="SEC-01"
                               data-descripcion="Descripción de prueba"
                               title="Editar">
                                <i class="fas fa-edit icono-accion"></i>
                            </a>

                            <a href="#"
                               class="btn bg-transparent btn-eliminar-seccion"
                               data-id="1"
                               title="Eliminar">
                                <i class="fas fa-trash-alt icono-accion"></i>
                            </a>
                        </td>
                    </tr>
                    <!-- Más secciones -->

                </tbody>
            </table>
            <!-- Modal Confirmar Eliminación Sección -->
            <div class="modal fade" id="modalEliminarSeccion" tabindex="-1" aria-labelledby="modalEliminarSeccionLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirmar Eliminación</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            ¿Está seguro que desea eliminar esta sección?
                        </div>
                        <div class="modal-footer">
                            <form id="formEliminarSeccion" method="post" action="">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-danger">Eliminar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>
    <!-- MODALES -->
    <!-- Modal Crear Especialidad -->
    <div class="modal fade" id="modalCrearEspecialidad" tabindex="-1" aria-labelledby="modalCrearEspecialidadLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="formCrearEspecialidad">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCrearEspecialidadLabel">Registrar Nueva Especialidad</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="nombreEspecialidad" class="form-label">Nombre de la especialidad <span style="color:#E04F4F">*</span></label>
                        <input type="text" id="nombreEspecialidad" name="nombreEspecialidad" placeholder="Ejemplo: Informática" required class="form-control mb-3" />

                        <label for="descripcionEspecialidad" class="form-label">Descripción <span style="color:#E04F4F">*</span></label>
                        <textarea id="descripcionEspecialidad" name="descripcionEspecialidad" placeholder="Breve descripción de la especialidad" required class="form-control"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-guardar">Guardar Especialidad</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Especialidad -->
    <div class="modal fade" id="modalEditarEspecialidad" tabindex="-1" aria-labelledby="modalEditarEspecialidadLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="formEditarEspecialidad">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarEspecialidadLabel">Editar Especialidad</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editarIdEspecialidad" name="id" />

                        <label for="editarNombreEspecialidad" class="form-label">Nombre de la especialidad <span style="color:#E04F4F">*</span></label>
                        <input type="text" id="editarNombreEspecialidad" name="nombreEspecialidad" class="form-control mb-3" required />

                        <label for="editarDescripcionEspecialidad" class="form-label">Descripción <span style="color:#E04F4F">*</span></label>
                        <textarea id="editarDescripcionEspecialidad" name="descripcionEspecialidad" class="form-control" required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-guardar">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Crear Sección -->
    <div class="modal fade" id="modalCrearSeccion" tabindex="-1" aria-labelledby="modalCrearSeccionLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="formCrearSeccion">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCrearSeccionLabel">Registrar Nueva Sección</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="nombreSeccion" class="form-label">Nombre de la sección <span style="color:#E04F4F">*</span></label>
                        <input type="text" id="nombreSeccion" name="nombreSeccion" placeholder="Ejemplo: Sección A" required class="form-control mb-3" />

                        <label for="descripcionSeccion" class="form-label">Descripción <span style="color:#E04F4F">*</span></label>
                        <textarea id="descripcionSeccion" name="descripcionSeccion" placeholder="Breve descripción de la sección" required class="form-control"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-guardar">Guardar Sección</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Sección -->
    <div class="modal fade" id="modalEditarSeccion" tabindex="-1" aria-labelledby="modalEditarSeccionLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="formEditarSeccion">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarSeccionLabel">Editar Sección</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editarIdSeccion" name="id" />

                        <label for="editarNombreSeccion" class="form-label">Nombre de la sección <span style="color:#E04F4F">*</span></label>
                        <input type="text" id="editarNombreSeccion" name="nombreSeccion" class="form-control mb-3" required />

                        <label for="editarDescripcionSeccion" class="form-label">Descripción <span style="color:#E04F4F">*</span></label>
                        <textarea id="editarDescripcionSeccion" name="descripcionSeccion" class="form-control" required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-guardar">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Rol Usuario -->
    <div class="modal fade" id="modalEditarRolUsuario" tabindex="-1" aria-labelledby="modalEditarRolUsuarioLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="formEditarRolUsuario">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarRolUsuarioLabel">Editar Rol de Usuario</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label>Nombre:</label>
                            <p id="rolNombre" class="fw-bold"></p>
                        </div>
                        <div class="mb-3">
                            <label>Cédula:</label>
                            <p id="rolCedula" class="fw-bold"></p>
                        </div>
                        <div class="mb-3">
                            <label>Email:</label>
                            <p id="rolEmail" class="fw-bold"></p>
                        </div>

                        <label for="rol" class="form-label">Rol <span style="color:#E04F4F">*</span></label>
                        <select id="rol" name="rol" required class="form-control mb-3">
                            <option value="">-- Seleccione un rol --</option>
                            <option value="Profesor">Profesor</option>
                            <option value="Estudiante">Estudiante</option>
                            <option value="Egresado">Egresado</option>
                            <option value="Coordinador">Coordinador</option>
                        </select>

                        <input type="hidden" id="usuarioId" name="usuarioId" />
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-guardar">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    @section Scripts {
        <!-- Font Awesome actualizado -->
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
              integrity="sha512-..." crossorigin="anonymous"
              referrerpolicy="no-referrer" />

        <script>

            $('.btn-editar-rol-usuario').on('click', function (e) {
                e.preventDefault();
                const id = $(this).data('id');
                const nombre = $(this).data('nombre');
                const cedula = $(this).data('cedula');
                const email = $(this).data('email');

                $('#rolNombre').text(nombre);
                $('#rolCedula').text(cedula);
                $('#rolEmail').text(email);
                $('#usuarioId').val(id);

                $('#modalEditarRolUsuario').modal('show');
            });


            $('.btn-editar-seccion').on('click', function (e) {
                e.preventDefault();
                const id = $(this).data('id');
                const nombre = $(this).data('nombre');
                const descripcion = $(this).data('descripcion');

                $('#editarIdSeccion').val(id);
                $('#editarNombreSeccion').val(nombre);
                $('#editarDescripcionSeccion').val(descripcion);

                $('#modalEditarSeccion').modal('show');
            });


            $('.btn-editar-especialidad').on('click', function (e) {
                e.preventDefault();
                const id = $(this).data('id');
                const nombre = $(this).data('nombre');
                const descripcion = $(this).data('descripcion');

                $('#editarIdEspecialidad').val(id);
                $('#editarNombreEspecialidad').val(nombre);
                $('#editarDescripcionEspecialidad').val(descripcion);

                $('#modalEditarEspecialidad').modal('show');
            });

            function mostrarSeccion(id) {
                document.querySelectorAll('.seccion-adm').forEach(s => s.style.display = 'none');
                const seccion = document.getElementById(id);
                if (seccion) seccion.style.display = 'block';

                document.querySelectorAll('.btn[onclick^="mostrarSeccion"]').forEach(btn => {
                    btn.classList.remove('btn-tab-active-usuarios', 'btn-tab-active-especialidades', 'btn-tab-active-secciones');
                });

                const btnActivo = document.querySelector(`button[onclick*="${id}"]`);
                if (btnActivo) {
                    btnActivo.classList.add(`btn-tab-active-${id}`);
                }

                if (id === 'usuarios') {
                    if ($.fn.DataTable.isDataTable('#tablaUsuarios')) {
                        $('#tablaUsuarios').DataTable().destroy();
                    }
                    $('#tablaUsuarios').DataTable({ responsive: true });
                }
            }

            $(document).ready(function () {
                // Inicializar DataTables
                $('table.display').not('#tablaUsuarios').each(function () {
                    $(this).DataTable({ responsive: true });
                });

                // Filtro por rol
                $('#filtroRol').on('change', function () {
                    const valor = this.value;
                    const tabla = $('#tablaUsuarios').DataTable();
                    tabla.column(3).search(valor).draw();
                });

                // Leer tab desde URL
                const params = new URLSearchParams(window.location.search);
                const tab = params.get('tab');
                mostrarSeccion(tab || 'usuarios');

                // Lógica común para eliminar filas de especialidades y secciones
                let filaAEliminar = null;

                $('.btn-eliminar-especialidad').on('click', function (e) {
                    e.preventDefault();
                    filaAEliminar = $(this).closest('tr');
                    $('#modalEliminarEspecialidad').modal('show');
                });

                $('#formEliminarEspecialidad').on('submit', function (e) {
                    e.preventDefault();
                    if (filaAEliminar) {
                        filaAEliminar.remove();
                        $('#modalEliminarEspecialidad').modal('hide');
                    }
                });

                $('.btn-eliminar-seccion').on('click', function (e) {
                    e.preventDefault();
                    filaAEliminar = $(this).closest('tr');
                    $('#modalEliminarSeccion').modal('show');
                });

                $('#formEliminarSeccion').on('submit', function (e) {
                    e.preventDefault();
                    if (filaAEliminar) {
                        filaAEliminar.remove();
                        $('#modalEliminarSeccion').modal('hide');
                    }
                });
            });

            function toggleEstado(btn) {
                const fila = btn.closest('tr');
                const celdaEstado = fila.querySelector('.estado');
                const icono = btn.querySelector('i');

                if (celdaEstado.textContent.trim() === 'Activo') {
                    celdaEstado.textContent = 'Inactivo';
                    btn.title = 'Activar';
                    icono.classList.remove('fa-user-slash');
                    icono.classList.add('fa-user-check');
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-outline-success');
                } else {
                    celdaEstado.textContent = 'Activo';
                    btn.title = 'Inactivar';
                    icono.classList.remove('fa-user-check');
                    icono.classList.add('fa-user-slash');
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-outline-danger');
                }
            }

            function confirmarCambioEstado(btn) {
                const fila = btn.closest('tr');
                const celdaEstado = fila.querySelector('.estado');
                const icono = btn.querySelector('i');
                const nombre = fila.querySelector('td').textContent.trim();

                const estadoActual = celdaEstado.textContent.trim();
                const nuevoEstado = estadoActual === 'Activo' ? 'Inactivo' : 'Activo';
                const mensaje = `¿Deseas ${nuevoEstado === 'Activo' ? 'activar' : 'inactivar'} al usuario ${nombre}?`;

                if (confirm(mensaje)) {
                    celdaEstado.textContent = nuevoEstado;
                    if (nuevoEstado === 'Inactivo') {
                        btn.title = 'Activar';
                        icono.classList.remove('fa-user-slash');
                        icono.classList.add('fa-user-check');
                        icono.style.color = '#768C46';
                    } else {
                        btn.title = 'Inactivar';
                        icono.classList.remove('fa-user-check');
                        icono.classList.add('fa-user-slash');
                        icono.style.color = '#2D594D';
                    }
                    alert(`Usuario ${nombre} ha sido marcado como ${nuevoEstado}.`);
                }
            }

            // Interceptar todos los formularios y simular confirmación
            $('#formCrearEspecialidad, #formEditarEspecialidad, #formCrearSeccion, #formEditarSeccion, #formEditarRolUsuario').on('submit', function (e) {
                e.preventDefault(); // evitar envío real del form

                Swal.fire({
                    icon: 'success',
                    title: 'Operación exitosa',
                    text: 'Los cambios han sido guardados correctamente.',
                    confirmButtonColor: '#2D594D'
                }).then(() => {
                    // Cerrar el modal correspondiente
                    $(this).closest('.modal').modal('hide');
                });
            });

        </script>
    }
